name: Build YOLOv9 ONNX (Multi Size + Multi Resolution)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·ï¼švYYYYMMDD
      - name: Generate Release Tag
        id: tag
        run: |
          TAG="v$(date +'%Y%m%d')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG"

      # éœ€è¦æ„å»ºçš„æ¨¡å‹å°ºå¯¸
      - name: Prepare Model List
        id: models
        run: echo "list=t s m c e" >> $GITHUB_OUTPUT

      # éœ€è¦æ„å»ºçš„å›¾åƒå°ºå¯¸
      - name: Prepare Image Size List
        id: imgs
        run: echo "sizes=320 640" >> $GITHUB_OUTPUT

      # æ‰¹é‡æ„å»ºæ‰€æœ‰æ¨¡å‹ + åˆ†è¾¨ç‡
      - name: Build all YOLOv9 Models
        shell: bash
        run: |
          for MODEL in ${{ steps.models.outputs.list }}; do
            for SIZE in ${{ steps.imgs.outputs.sizes }}; do
              echo "ğŸ”¥ Building YOLOv9-$MODEL ($SIZE)..."
              # ç”Ÿæˆä¸´æ—¶ Dockerfile
              cat <<'EOF' > Dockerfile.temp
                FROM python:3.11 AS build
                RUN apt-get update && apt-get install --no-install-recommends -y libgl1 && rm -rf /var/lib/apt/lists/*
                COPY --from=ghcr.io/astral-sh/uv:0.8.0 /uv /bin/
                WORKDIR /yolov9
                ADD https://github.com/WongKinYiu/yolov9.git .
                RUN uv pip install --system -r requirements.txt
                RUN uv pip install --system onnx==1.18.0 onnxruntime onnx-simplifier>=0.4.1 onnxscript
                ARG MODEL_SIZE
                ARG IMG_SIZE
                ADD https://github.com/WongKinYiu/yolov9/releases/download/v0.1/yolov9-${MODEL_SIZE}-converted.pt yolov9-${MODEL_SIZE}.pt
                RUN sed -i "s/ckpt = torch.load(attempt_download(w), map_location='cpu')/ckpt = torch.load(attempt_download(w), map_location='cpu', weights_only=False)/g" models/experimental.py
                RUN python3 export.py --weights ./yolov9-${MODEL_SIZE}.pt --imgsz ${IMG_SIZE} --simplify --include onnx
                FROM scratch
                ARG MODEL_SIZE
                ARG IMG_SIZE
                COPY --from=build /yolov9/yolov9-${MODEL_SIZE}.onnx /yolov9-${MODEL_SIZE}-${IMG_SIZE}.onnx
                EOF

              docker build \
                --build-arg MODEL_SIZE=$MODEL \
                --build-arg IMG_SIZE=$SIZE \
                -f Dockerfile.temp \
                --output . .

              echo "â¡ï¸ Generated: yolov9-$MODEL-$SIZE.onnx"
            done
          done

      # åˆ é™¤æ—§ releaseï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Delete old release if exists
        continue-on-error: true
        run: |
          gh release delete "${{ steps.tag.outputs.tag }}" -y
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # åˆ é™¤æ—§ tagï¼ˆè‹¥å­˜åœ¨ï¼‰
      - name: Delete old tag if exists
        continue-on-error: true
        run: |
          git push origin :refs/tags/${{ steps.tag.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # åˆ›å»ºæ–° release
      - name: Create Release
        run: |
          gh release create "${{ steps.tag.outputs.tag }}" \
            -t "YOLOv9 ONNX ${{
                steps.tag.outputs.tag }}" \
            -n "Auto-built YOLOv9 ONNX models for all sizes and resolutions."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ æ‰€æœ‰ç”Ÿæˆçš„æ¨¡å‹æ–‡ä»¶
      - name: Upload All ONNX Models
        run: |
          gh release upload "${{ steps.tag.outputs.tag }}" \
            yolov9-*.onnx \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
