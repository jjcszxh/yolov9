name: Build YOLOv9 ONNX (All Models)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Define model parameters
      run: |
        echo 'MODEL_SIZES=("t" "s" "m" "c" "e")' >> $GITHUB_ENV
        echo 'IMG_SIZES=("320" "640")' >> $GITHUB_ENV
        echo "RELEASE_TAG=v1.0" >> $GITHUB_ENV

    - name: Build ALL YOLOv9 ONNX Models
      run: |
        for MODEL in t s m c e; do
          for SIZE in 320 640; do
            echo "=== Building YOLOv9-$MODEL at $SIZE ==="

            docker build . \
              --build-arg MODEL_SIZE=$MODEL \
              --build-arg IMG_SIZE=$SIZE \
              --output . \
              -f- <<'EOF'
            FROM python:3.11 AS build
            RUN apt-get update && apt-get install --no-install-recommends -y libgl1 && rm -rf /var/lib/apt/lists/*
            COPY --from=ghcr.io/astral-sh/uv:0.8.0 /uv /bin/
            WORKDIR /yolov9
            ADD https://github.com/WongKinYiu/yolov9.git .
            RUN uv pip install --system -r requirements.txt
            RUN uv pip install --system onnx==1.18.0 onnxruntime onnx-simplifier>=0.4.1 onnxscript
            ARG MODEL_SIZE
            ARG IMG_SIZE
            ADD https://github.com/WongKinYiu/yolov9/releases/download/v0.1/yolov9-${MODEL_SIZE}-converted.pt yolov9-${MODEL_SIZE}.pt
            RUN sed -i "s/ckpt = torch.load(attempt_download(w), map_location='cpu')/ckpt = torch.load(attempt_download(w), map_location='cpu', weights_only=False)/g" models/experimental.py
            RUN python3 export.py --weights ./yolov9-${MODEL_SIZE}.pt --imgsz ${IMG_SIZE} --simplify --include onnx
            FROM scratch
            ARG MODEL_SIZE
            ARG IMG_SIZE
            COPY --from=build /yolov9/yolov9-${MODEL_SIZE}.onnx /yolov9-${MODEL_SIZE}-${IMG_SIZE}.onnx
            EOF

          done
        done

    - name: Install GitHub CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y gh

    - name: Ensure release exists
      run: |
        gh release view "$RELEASE_TAG" || \
        gh release create "$RELEASE_TAG" -t "YOLOv9 ALL ONNX MODELS" -n "Auto-generated complete model pack"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload all ONNX models
      run: |
        for FILE in yolov9-*.onnx; do
          echo "Uploading $FILE ..."
          gh release upload "$RELEASE_TAG" "$FILE" --clobber
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
